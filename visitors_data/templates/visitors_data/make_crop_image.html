{% extends 'base.html' %}

{% load static %}

{% block css %}
<script type="text/javascript" src="{% static 'html2canvas.min.js' %} "></script>
{% endblock %}

{% block body %}

<div style="position: relative;"></div>

<button>take a snapshot</button>
<video></video>
<div style="position: relative; left:560px; top: -195px;">
    <hr width =21% color="66FF33" align="left" size=5/>

<div style="position: relative; left:0px; top: -430px;" >
    <hr width =21% color="66FF33" align="left" size=5/>

<div style="position: relative; left:0px; top: -13px;" >
    <hr width = 3 color="66FF33" align="left" size=422/>   

<div style="position: relative; left:395px; top: -430px;" >
    <hr width = 3 color="66FF33" align="left" size=422/>  
</div>
<hr>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    $(document).ready(function(){
        const vid = document.querySelector('video');
        navigator.mediaDevices.getUserMedia({video: true}) // request cam
        .then(stream => {
            vid.srcObject = stream; // don't use createObjectURL(MediaStream)
            vid.width=1280;
            vid.height=780;
        return vid.play(); // returns a Promise
    })
    .then(() => { // enable the button
        const btn = document.querySelector('button');
        btn.disabled = false;
        btn.onclick = e => {
            takeASnap()
            // Promise 객체 반환
            .then(download)
            // .then(download);
            
        };
    });

    function takeASnap() {
            const canvas = document.createElement('canvas'); // create a canvas
            const ctx = canvas.getContext('2d'); // get its context
            canvas.width = vid.videoWidth; // set its size to the one of the video
            canvas.height = vid.videoHeight;
            // ctx.scale(-1, 1);
            ctx.drawImage(vid, 0, 0); // the video
            return new Promise((res, rej)=>{
                canvas.toBlob(res, 'image/jpeg'); // request a Blob from the canvas
        });
    }
    
    function download(blob) {
        // uses the <a download> to download a Blob
        let a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob);
        a.download = 'picture.png';
        document.body.appendChild(a);
        const blobImageUrl = URL.createObjectURL(blob)
        console.log(blobImageUrl)

        const requestForm = new FormData()
        requestForm.append('image', blobImageUrl)

        axios.defaults.xsrfCookieName = 'csrftoken'
        axios.defaults.xsrfHeaderName = 'X-CSRFToken'
        // https://686f9b8a3f69.ngrok.io/
        axios.post('https://96c97b6071a7.ngrok.io/visitors/get_crop_image/', requestForm)
        .then(res => {
            console.log(res)
            // window.location.replace("http://127.0.0.1:8000/visitors/get_crop_image/");
        })
        
        .catch(err => {
            console.error(err)
        })
        a.click();
    }

    function sendCropImage(blob) {
        const blobImageUrl = URL.createObjectURL(blob)
        console.log(blobImageUrl)

        const requestForm = new FormData()
        requestForm.append('image', blobImageUrl)

        axios.defaults.xsrfCookieName = 'csrftoken'
        axios.defaults.xsrfHeaderName = 'X-CSRFToken'
        // https://686f9b8a3f69.ngrok.io/
        axios.post('https://686f9b8a3f69.ngrok.io/visitors/get_crop_image/', requestForm)
        .then(res => {
            console.log(res)
            // window.location.replace("http://127.0.0.1:8000/visitors/get_crop_image/");
        })
        .catch(err => {
            console.error(err)
        })
    }
})
</script>
{% endblock %}